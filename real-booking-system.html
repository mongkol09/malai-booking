<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การจองห้องพักจริง - Real Booking System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .booking-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step-indicator {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }
        .result-card {
            border-left: 4px solid #28a745;
            background: #f8f9fa;
        }
        .error-card {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <!-- API Status Indicator -->
    <div id="apiStatus" class="api-status">
        <div class="alert alert-info" role="alert">
            <i class="bi bi-wifi me-2"></i>
            <span id="statusText">กำลังตรวจสอบ API...</span>
        </div>
    </div>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="booking-card bg-success text-white p-4">
                    <h1 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        การจองห้องพักจริง - Real Booking System
                    </h1>
                    <p class="mb-0 mt-2">เชื่อมต่อกับ API จริง และบันทึกลงฐานข้อมูล</p>
                    <small class="d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        ข้อมูลจะปรากฏในหน้า Admin: http://localhost:3000/room-booking-list
                    </small>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="row">
            <div class="col-lg-8">
                <div class="booking-card p-4 mb-4">
                    <div class="step-indicator">1</div>
                    <h3 class="text-center mb-4">ข้อมูลการจองห้องพัก</h3>
                    
                    <form id="realBookingForm">
                        <!-- Guest Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="bi bi-person me-2"></i>ข้อมูลผู้เข้าพัก</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">ชื่อ-นามสกุล *</label>
                                        <input type="text" class="form-control" id="guestName" value="คุณทดสอบ การจองจริง" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">อีเมล *</label>
                                        <input type="email" class="form-control" id="guestEmail" value="real.booking@hotel.test" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">เบอร์โทรศัพท์ *</label>
                                        <input type="tel" class="form-control" id="guestPhone" value="081-234-5678" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">สัญชาติ</label>
                                        <select class="form-select" id="nationality">
                                            <option value="Thai" selected>ไทย</option>
                                            <option value="American">อเมริกัน</option>
                                            <option value="Japanese">ญี่ปุ่น</option>
                                            <option value="Chinese">จีน</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Room Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="bi bi-house me-2"></i>ข้อมูลห้องพัก</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">ประเภทห้อง *</label>
                                        <select class="form-select" id="roomType" required>
                                            <option value="Onsen" selected>Onsen Room</option>
                                            <option value="Deluxe">Deluxe Room</option>
                                            <option value="Standard">Standard Room</option>
                                            <option value="Suite">Suite Room</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">จำนวนผู้เข้าพัก</label>
                                        <select class="form-select" id="guestCount">
                                            <option value="1">1 ท่าน</option>
                                            <option value="2" selected>2 ท่าน</option>
                                            <option value="3">3 ท่าน</option>
                                            <option value="4">4 ท่าน</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">วันเข้าพัก *</label>
                                        <input type="date" class="form-control" id="checkinDate" value="2025-08-19" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">วันออก *</label>
                                        <input type="date" class="form-control" id="checkoutDate" value="2025-08-20" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="bi bi-credit-card me-2"></i>ข้อมูลการชำระเงิน</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">วิธีการชำระ</label>
                                        <select class="form-select" id="paymentMethod">
                                            <option value="credit_card" selected>บัตรเครดิต</option>
                                            <option value="bank_transfer">โอนเงิน</option>
                                            <option value="cash">เงินสด</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">สถานะการชำระ</label>
                                        <select class="form-select" id="paymentStatus">
                                            <option value="paid" selected>ชำระแล้ว</option>
                                            <option value="pending">รอชำระ</option>
                                            <option value="partial">ชำระบางส่วน</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="bi bi-chat-dots me-2"></i>ความต้องการพิเศษ</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="specialRequests" rows="3" placeholder="ระบุความต้องการพิเศษ (ถ้ามี)">ขอห้องที่เงียบ และขอผ้าเช็ดตัวเพิ่ม - การจองจริงผ่าน API</textarea>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn">
                                <i class="bi bi-calendar-check me-2"></i>
                                สร้างการจองจริง
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Summary & Results -->
            <div class="col-lg-4">
                <div class="booking-card p-4 mb-4">
                    <div class="step-indicator">2</div>
                    <h4 class="text-center mb-3">สรุปการจอง</h4>
                    <div id="bookingSummary">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            กรอกข้อมูลและกดสร้างการจองเพื่อบันทึกลงระบบ
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingCard" class="booking-card p-4 mb-4 loading">
                    <div class="text-center">
                        <div class="spinner-border text-success mb-3" role="status">
                            <span class="visually-hidden">กำลังสร้างการจอง...</span>
                        </div>
                        <h5>กำลังบันทึกลงฐานข้อมูล...</h5>
                        <p class="text-muted">กรุณารอสักครู่</p>
                    </div>
                </div>

                <!-- Results -->
                <div id="resultsCard" class="booking-card p-4 loading">
                    <div class="step-indicator">3</div>
                    <h4 class="text-center mb-3">ผลการจอง</h4>
                    <div id="bookingResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3001/api/v1';
        let apiHealthy = false;

        // Check API health
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE_URL.replace('/api/v1', '')}/health`);
                if (response.ok) {
                    apiHealthy = true;
                    document.getElementById('statusText').innerHTML = '<i class="bi bi-check-circle me-2"></i>API เชื่อมต่อแล้ว';
                    document.getElementById('apiStatus').className = 'api-status';
                    document.getElementById('apiStatus').firstElementChild.className = 'alert alert-success';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                apiHealthy = false;
                document.getElementById('statusText').innerHTML = '<i class="bi bi-x-circle me-2"></i>API ไม่พร้อม';
                document.getElementById('apiStatus').firstElementChild.className = 'alert alert-danger';
            }
        }

        // Calculate pricing
        function calculatePricing(roomType, nights) {
            const rates = {
                'Onsen': 3500,
                'Deluxe': 2500,
                'Standard': 1500,
                'Suite': 5000
            };
            
            const roomRate = rates[roomType] || 2000;
            const subtotal = roomRate * nights;
            const taxes = Math.round(subtotal * 0.1); // 10% tax
            const fees = 100; // Service fee
            const totalAmount = subtotal + taxes + fees;
            
            return {
                roomRate,
                subtotal,
                taxes,
                fees,
                totalAmount,
                currency: 'THB'
            };
        }

        // Update summary when form changes
        function updateSummary() {
            const guestName = document.getElementById('guestName').value;
            const roomType = document.getElementById('roomType').value;
            const checkinDate = document.getElementById('checkinDate').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const guestCount = document.getElementById('guestCount').value;

            const checkin = new Date(checkinDate);
            const checkout = new Date(checkoutDate);
            const nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
            
            const pricing = calculatePricing(roomType, nights);

            const summary = `
                <div class="card">
                    <div class="card-body">
                        <h6><i class="bi bi-person-fill me-2"></i>ผู้เข้าพัก</h6>
                        <p class="mb-2">${guestName || 'ยังไม่ได้กรอก'}</p>
                        
                        <h6><i class="bi bi-house-fill me-2"></i>ห้องพัก</h6>
                        <p class="mb-2">${roomType} - ${guestCount} ท่าน</p>
                        
                        <h6><i class="bi bi-calendar-fill me-2"></i>วันที่</h6>
                        <p class="mb-2">เข้าพัก: ${checkin.toLocaleDateString('th-TH')}</p>
                        <p class="mb-2">ออก: ${checkout.toLocaleDateString('th-TH')}</p>
                        <p class="mb-3"><strong>${nights} คืน</strong></p>
                        
                        <h6><i class="bi bi-cash me-2"></i>ราคา</h6>
                        <div class="d-flex justify-content-between">
                            <span>ค่าห้อง ${nights} คืน:</span>
                            <span>฿${pricing.subtotal.toLocaleString()}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ภาษี (10%):</span>
                            <span>฿${pricing.taxes.toLocaleString()}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ค่าบริการ:</span>
                            <span>฿${pricing.fees.toLocaleString()}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>รวมทั้งสิ้น:</span>
                            <span class="text-success">฿${pricing.totalAmount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('bookingSummary').innerHTML = summary;
        }

        // Create real booking
        async function createRealBooking(formData) {
            if (!apiHealthy) {
                throw new Error('API ไม่พร้อมใช้งาน กรุณาตรวจสอบว่า Backend เปิดอยู่ที่ localhost:3001');
            }

            const response = await fetch(`${API_BASE_URL}/bookings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorData}`);
            }

            return await response.json();
        }

        // Form submission
        document.getElementById('realBookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Show loading
            document.getElementById('loadingCard').classList.add('show');
            document.getElementById('resultsCard').classList.remove('show');
            document.getElementById('submitBtn').disabled = true;

            // Collect form data
            const checkinDate = document.getElementById('checkinDate').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const roomType = document.getElementById('roomType').value;
            
            const checkin = new Date(checkinDate);
            const checkout = new Date(checkoutDate);
            const nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
            const pricing = calculatePricing(roomType, nights);
            
            const formData = {
                guest: {
                    name: document.getElementById('guestName').value,
                    email: document.getElementById('guestEmail').value,
                    phone: document.getElementById('guestPhone').value,
                    nationality: document.getElementById('nationality').value
                },
                room: {
                    type: roomType,
                    guests: parseInt(document.getElementById('guestCount').value),
                    preferences: document.getElementById('specialRequests').value
                },
                dates: {
                    checkin: checkinDate,
                    checkout: checkoutDate,
                    nights: nights
                },
                pricing: pricing,
                specialRequests: document.getElementById('specialRequests').value,
                source: "Real Booking Test - Web Form",
                paymentMethod: document.getElementById('paymentMethod').value,
                status: "confirmed"
            };

            try {
                console.log('🏨 Creating real booking...', formData);
                
                const result = await createRealBooking(formData);

                // Show success results
                let resultsHtml = `
                    <div class="result-card p-3 mb-3">
                        <h5 class="text-success mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            การจองสำเร็จ! (บันทึกลงฐานข้อมูลแล้ว)
                        </h5>
                        <p><strong>รหัสการจอง:</strong> <code>${result.bookingReferenceId || result.id}</code></p>
                        <p><strong>QR Code:</strong> <code>${result.qrCode || 'Generated'}</code></p>
                        <p><strong>ห้อง:</strong> ${result.room?.number || 'รอจัดสรร'}</p>
                        <p><strong>ยอดเงิน:</strong> ฿${(result.pricing?.totalAmount || pricing.totalAmount).toLocaleString()}</p>
                        
                        <div class="alert alert-success mt-3">
                            <h6><i class="bi bi-info-circle me-2"></i>ตรวจสอบการจอง:</h6>
                            <p class="mb-1">1. เปิดหน้า Admin Panel: <a href="http://localhost:3000/room-booking-list" target="_blank">Room Booking List</a></p>
                            <p class="mb-0">2. ค้นหาด้วยรหัส: <strong>${result.bookingReferenceId || result.id}</strong></p>
                        </div>
                    </div>
                `;

                document.getElementById('bookingResults').innerHTML = resultsHtml;

            } catch (error) {
                console.error('❌ Error creating real booking:', error);
                
                document.getElementById('bookingResults').innerHTML = `
                    <div class="error-card p-3">
                        <h5 class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            การจองไม่สำเร็จ
                        </h5>
                        <p class="mb-2"><strong>สาเหตุ:</strong> ${error.message}</p>
                        
                        <div class="mt-3">
                            <h6>วิธีแก้ไข:</h6>
                            <ul class="small">
                                <li>ตรวจสอบว่า Backend API เปิดอยู่ที่ localhost:3001</li>
                                <li>ตรวจสอบการเชื่อมต่อฐานข้อมูล</li>
                                <li>ดู error logs ใน terminal Backend</li>
                            </ul>
                        </div>
                    </div>
                `;
            } finally {
                // Hide loading and show results
                document.getElementById('loadingCard').classList.remove('show');
                document.getElementById('resultsCard').classList.add('show');
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkApiHealth();
            updateSummary();
            
            // Update summary on form changes
            ['guestName', 'roomType', 'checkinDate', 'checkoutDate', 'guestCount'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateSummary);
                document.getElementById(id).addEventListener('input', updateSummary);
            });

            // Check API health every 30 seconds
            setInterval(checkApiHealth, 30000);
        });
    </script>
</body>
</html>
