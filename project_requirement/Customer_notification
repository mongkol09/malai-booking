ภาพรวม: จากการจองสำเร็จสู่อีเมลในมือลูกค้า
เป้าหมายของ Flow นี้คือการส่งอีเมลยืนยันการจองที่ "สมบูรณ์" ให้กับลูกค้าทันที ซึ่งอีเมลนี้ไม่ได้เป็นแค่ใบเสร็จ แต่ยังทำหน้าที่เป็น "เอกสารยืนยันสำหรับการเช็คอิน" ได้อีกด้วย
เส้นทางของข้อมูล: ลูกค้าจองสำเร็จ (Booking Completed) → Backend เตรียมข้อมูลและสร้างอีเมล → Backend ยิง API ไปยัง Mailersend → Mailersend ส่งอีเมลให้ลูกค้า → ลูกค้าได้รับอีเมลยืนยัน
ขั้นตอนที่ 1: จุดเริ่มต้น - การจองเสร็จสมบูรณ์ (The Trigger)
เกิดขึ้นเมื่อไหร่: เกิดขึ้นทันทีหลังจาก ขั้นตอนที่ 6 (The Confirmation) ใน Flow การจองของลูกค้าเสร็จสิ้น และ Backend ได้ทำการ INSERT ข้อมูลลงในตาราง Bookings และ Payments เรียบร้อยแล้ว
การทำงาน: หลังจากที่ Backend ทำงานทุกอย่างในฝั่งของตัวเองเสร็จ (อัปเดต DB, ส่งสัญญาณไปที่ Dashboard) มันจะเรียกใช้ Service ภายในตัวหนึ่งที่เราจะเรียกว่า EmailService
ขั้นตอนที่ 2: การเตรียมข้อมูลและสร้างเนื้อหาอีเมล (Data & Content Generation)
นี่คือขั้นตอนที่ระบบจะรวบรวมข้อมูลทั้งหมดเพื่อสร้างอีเมลที่สวยงามและมีประโยชน์
ทำงานอย่างไร:
รวบรวมข้อมูล (Data Gathering): EmailService จะดึงข้อมูลทั้งหมดที่จำเป็นจากการจองที่เพิ่งสร้างเสร็จ:
ข้อมูลหลัก:
หมายเลขอ้างอิงการจอง (Booking Reference ID)
ชื่อ-นามสกุลผู้เข้าพัก
อีเมลและเบอร์โทรศัพท์
รายละเอียดการเข้าพัก:
วันที่และเวลาเช็คอิน-เช็คเอาท์
ประเภทห้องที่จอง (Private House, Onsen Room)
จำนวนผู้เข้าพัก
รายละเอียดทางการเงิน:
ราคารวมที่ชำระ
รายการแจกแจงราคา (Price Breakdown)
ข้อมูลโรงแรม:
ชื่อ, ที่อยู่, เบอร์โทรติดต่อ, และลิงก์แผนที่ของที่พัก
สร้างฟีเจอร์พิเศษสำหรับเช็คอิน (QR Code Generation):
ระบบจะนำ "หมายเลขอ้างอิงการจอง" มาสร้างเป็น QR Code โดยอัตโนมัติ
เมื่อลูกค้ามาถึงที่พัก พนักงานต้อนรับสามารถใช้สแกนเนอร์หรือแอปบนมือถือสแกน QR Code นี้เพื่อดึงข้อมูลการจองขึ้นมาได้ทันที ทำให้กระบวนการเช็คอินรวดเร็วและทันสมัยมาก
สร้างเนื้อหา HTML (HTML Content Generation):
คุณควรจะมี "Template อีเมล" ที่ออกแบบไว้ล่วงหน้าอย่างสวยงาม (สามารถสร้างได้ง่ายๆ ใน Mailersend)
EmailService จะนำข้อมูลทั้งหมดที่รวบรวมมา รวมทั้งรูปภาพ QR Code ไป "เติม" ลงใน Template นี้
ขั้นตอนที่ 3: การส่งอีเมลผ่าน Mailersend API (The API Call)
ทำงานอย่างไร:
สร้าง API Request: EmailService จะสร้าง HTTP POST Request เพื่อยิงไปที่ API ของ Mailersend (https://api.mailersend.com/v1/email)
ประกอบ Payload: Request Body จะมีข้อมูลตามที่ Mailersend กำหนด:
{
  "from": { "email": "booking@yourhotel.com", "name": "Your Hotel Name" },
  "to": [
    { "email": "customer_email@example.com", "name": "Customer Name" }
  ],
  "subject": "ยืนยันการจองหมายเลข #B-12345 ที่ Your Hotel Name",
  "html": "<html>...เนื้อหาอีเมลทั้งหมดที่สร้างจาก Template...</html>"
}


ยืนยันตัวตนและส่ง: Request จะถูกส่งไปพร้อมกับ Authorization Header ที่มี API Key ของ Mailersend
ขั้นตอนที่ 4: การบันทึกและจัดการข้อผิดพลาด (Logging & Error Handling)
นี่คือขั้นตอนที่ทำให้ระบบของคุณแข็งแกร่งและน่าเชื่อถือ
กรณีส่งสำเร็จ (Success):
Mailersend API จะตอบกลับมาด้วยสถานะสำเร็จ (เช่น 202 Accepted)
ระบบควรบันทึกสถานะนี้ไว้ อาจจะมีการ UPDATE field ในตาราง Bookings ว่า confirmation_email_sent_at = now()
กรณีส่งไม่สำเร็จ (Failure):
อาจเกิดจากอีเมลลูกค้าไม่ถูกต้อง หรือเซิร์ฟเวอร์ของ Mailersend มีปัญหาชั่วคราว
สำคัญมาก: การส่งอีเมลไม่สำเร็จ จะต้องไม่ทำให้การจองทั้งหมดล้มเหลว เพราะลูกค้าชำระเงินแล้ว
สิ่งที่ระบบควรทำ:
บันทึกข้อผิดพลาด (Log Error): บันทึก Error ที่ได้รับจาก Mailersend ไว้อย่างละเอียด
เข้าคิวเพื่อลองใหม่ (Retry Queue): นำ Job การส่งอีเมลนี้ไปใส่ไว้ใน "คิว" แล้วให้ระบบเบื้องหลัง (Background Worker) พยายามส่งใหม่ในอีก 5 นาที, 15 นาที, และ 1 ชั่วโมงต่อมา
แจ้งเตือนแอดมิน: หากพยายามส่งใหม่หลายครั้งแล้วยังล้มเหลว ระบบควรส่งการแจ้งเตือนภายในให้แอดมินทราบ เพื่อให้สามารถติดต่อลูกค้าหรือแก้ไขปัญหาได้
ด้วย Flow นี้ คุณจะมั่นใจได้ว่าลูกค้าทุกคนจะได้รับอีเมลยืนยันการจองที่สวยงามและมีประโยชน์ในทันที และระบบยังสามารถรับมือกับข้อผิดพลาดที่อาจเกิดขึ้นได้อย่างมืออาชีพครับ

