<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Fix Login Issues</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .warning { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f8fff8; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .clear-btn { background: #dc3545; }
        .clear-btn:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Login System</h1>
    
    <div class="step warning">
        <h3>üö® ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h3>
        <ul>
            <li><strong>JsonWebTokenError: invalid signature</strong> - Token ‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô localStorage ‡∏°‡∏µ signature ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
            <li><strong>Dev token bypass</strong> ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î backend (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)</li>
            <li><strong>Old dev token</strong> ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô browser localStorage</li>
        </ul>
    </div>

    <div class="step">
        <h3>üßπ Step 1: Clear All Old Tokens</h3>
        <p>‡∏•‡∏ö token ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å localStorage:</p>
        <button class="clear-btn" onclick="clearAllTokens()">üóëÔ∏è Clear All Tokens</button>
        <div id="clearResult"></div>
    </div>

    <div class="step">
        <h3>üîê Step 2: Fresh Login</h3>
        <p>Login ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ valid token:</p>
        <button onclick="freshLogin()">üöÄ Login with Admin Account</button>
        <div id="loginResult"></div>
    </div>

    <div class="step">
        <h3>üîç Step 3: Verify Token</h3>
        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ token ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</p>
        <button onclick="testToken()">‚úÖ Test API with New Token</button>
        <div id="testResult"></div>
    </div>

    <div class="step success">
        <h3>‚úÖ Expected Result:</h3>
        <p>‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Room Status page ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ 401 errors</p>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api/v1';
        
        function clearAllTokens() {
            const keys = ['hotel_admin_token', 'hotel_admin_refresh_token', 'hotel_admin_user', 'token'];
            const cleared = [];
            
            keys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    cleared.push(key);
                }
            });
            
            const resultDiv = document.getElementById('clearResult');
            if (cleared.length > 0) {
                resultDiv.innerHTML = `
                    <div class="result" style="background: #fff5f5; color: #721c24; border: 1px solid #f5c6cb;">
                        <strong>üóëÔ∏è Cleared tokens:</strong><br>
                        ${cleared.map(key => `‚Ä¢ ${key}`).join('<br>')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result" style="background: #f8fff8; color: #155724; border: 1px solid #c3e6cb;">
                        <strong>‚úÖ No old tokens found - localStorage is clean</strong>
                    </div>
                `;
            }
        }
        
        async function freshLogin() {
            const resultDiv = document.getElementById('loginResult');
            
            try {
                console.log('üîê Starting fresh login...');
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@hotel.com',
                        password: 'SecureAdmin123!'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Save new tokens
                    localStorage.setItem('hotel_admin_token', data.data.tokens.accessToken);
                    localStorage.setItem('token', data.data.tokens.accessToken);
                    localStorage.setItem('hotel_admin_refresh_token', data.data.tokens.refreshToken);
                    localStorage.setItem('hotel_admin_user', JSON.stringify(data.data.user));
                    
                    resultDiv.innerHTML = `
                        <div class="result" style="background: #f8fff8; color: #155724; border: 1px solid #c3e6cb;">
                            <strong>‚úÖ Login successful!</strong><br>
                            ‚Ä¢ User: ${data.data.user.firstName} ${data.data.user.lastName}<br>
                            ‚Ä¢ Email: ${data.data.user.email}<br>
                            ‚Ä¢ Role: ${data.data.user.userType}<br>
                            ‚Ä¢ Token: ${data.data.tokens.accessToken.substring(0, 30)}...<br>
                            <strong>üíæ New token saved to localStorage</strong>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result" style="background: #fff5f5; color: #721c24; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Login failed:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        async function testToken() {
            const resultDiv = document.getElementById('testResult');
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.innerHTML = `
                    <div class="result" style="background: #fff5f5; color: #721c24; border: 1px solid #f5c6cb;">
                        <strong>‚ùå No token found!</strong><br>
                        Please login first.
                    </div>
                `;
                return;
            }
            
            try {
                console.log('üß™ Testing API with new token...');
                
                // Test multiple endpoints
                const tests = [
                    { name: 'Rooms', endpoint: '/rooms/' },
                    { name: 'Arrivals', endpoint: '/bookings/arrivals' },
                    { name: 'Departures', endpoint: '/bookings/departures' }
                ];
                
                const results = [];
                
                for (const test of tests) {
                    try {
                        const response = await fetch(`${API_BASE_URL}${test.endpoint}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            results.push(`‚úÖ ${test.name}: OK (${response.status})`);
                        } else {
                            results.push(`‚ùå ${test.name}: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        results.push(`‚ùå ${test.name}: ${error.message}`);
                    }
                }
                
                const allPassed = results.every(r => r.includes('‚úÖ'));
                
                resultDiv.innerHTML = `
                    <div class="result" style="background: ${allPassed ? '#f8fff8' : '#fff5f5'}; color: ${allPassed ? '#155724' : '#721c24'}; border: 1px solid ${allPassed ? '#c3e6cb' : '#f5c6cb'};">
                        <strong>üß™ API Test Results:</strong><br>
                        ${results.join('<br>')}
                        <br><br>
                        ${allPassed ? 
                            '<strong>üéâ All tests passed! Your Room Status page should work now.</strong>' : 
                            '<strong>‚ö†Ô∏è Some tests failed. Please check your login and try again.</strong>'
                        }
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result" style="background: #fff5f5; color: #721c24; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Test failed:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
