<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #2a2a2a; }
        .key { color: #66d9ef; }
        .value { color: #a6e22e; }
        .error { color: #f92672; }
        .success { color: #a6e22e; }
        button { padding: 10px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug Tool</h1>
    
    <div class="section">
        <h2>üì± Current localStorage Data</h2>
        <div id="localStorage-data">Loading...</div>
        <button onclick="refreshLocalStorage()">üîÑ Refresh</button>
        <button onclick="clearAllData()">üóëÔ∏è Clear All</button>
    </div>

    <div class="section">
        <h2>üîê Test Login</h2>
        <button onclick="testLogin()">üöÄ Test Login API</button>
        <div id="login-result"></div>
    </div>

    <div class="section">
        <h2>üë§ User Role Check</h2>
        <div id="role-check">Click refresh to check...</div>
        <button onclick="checkUserRole()">üîç Check Role</button>
    </div>

    <script>
        function refreshLocalStorage() {
            const data = {};
            const keys = ['hotel_auth_token', 'hotel_auth_refresh_token', 'hotel_auth_user'];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                data[key] = value ? value : null;
            });

            let html = '<pre>';
            for (const [key, value] of Object.entries(data)) {
                html += `<span class="key">${key}:</span> `;
                if (value) {
                    if (key.includes('user') && value !== 'null') {
                        try {
                            const user = JSON.parse(value);
                            html += `<span class="success">‚úÖ ${JSON.stringify(user, null, 2)}</span>\n`;
                        } catch (e) {
                            html += `<span class="error">‚ùå Invalid JSON: ${value}</span>\n`;
                        }
                    } else if (value !== 'null') {
                        html += `<span class="value">‚úÖ ${value.substring(0, 50)}...</span>\n`;
                    } else {
                        html += `<span class="error">‚ùå null</span>\n`;
                    }
                } else {
                    html += `<span class="error">‚ùå Not found</span>\n`;
                }
            }
            html += '</pre>';
            
            document.getElementById('localStorage-data').innerHTML = html;
        }

        function clearAllData() {
            if (confirm('Clear all authentication data?')) {
                localStorage.removeItem('hotel_auth_token');
                localStorage.removeItem('hotel_auth_refresh_token');
                localStorage.removeItem('hotel_auth_user');
                refreshLocalStorage();
                alert('‚úÖ All data cleared!');
            }
        }

        function checkUserRole() {
            const userStr = localStorage.getItem('hotel_auth_user');
            let html = '';
            
            if (!userStr || userStr === 'null') {
                html = '<span class="error">‚ùå No user data found</span>';
            } else {
                try {
                    const user = JSON.parse(userStr);
                    html = `<pre><span class="success">‚úÖ User found:</span>
<span class="key">Email:</span> <span class="value">${user.email || 'N/A'}</span>
<span class="key">Role:</span> <span class="value">${user.role || 'N/A'}</span>
<span class="key">UserType:</span> <span class="value">${user.userType || 'N/A'}</span>
<span class="key">Name:</span> <span class="value">${user.firstName || ''} ${user.lastName || ''}</span>
<span class="key">Active:</span> <span class="value">${user.isActive || 'N/A'}</span>

<span class="key">Permission Check:</span>
- DEV Role: <span class="${user.role === 'DEV' ? 'success' : 'error'}">${user.role === 'DEV' ? '‚úÖ' : '‚ùå'}</span>
- Role Field: <span class="${user.role ? 'success' : 'error'}">${user.role ? '‚úÖ' : '‚ùå'}</span></pre>`;
                } catch (e) {
                    html = `<span class="error">‚ùå Invalid user JSON: ${e.message}</span>`;
                }
            }
            
            document.getElementById('role-check').innerHTML = html;
        }

        async function testLogin() {
            document.getElementById('login-result').innerHTML = 'üîÑ Testing login...';
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'hotel-booking-api-key-2024'
                    },
                    body: JSON.stringify({
                        email: 'mongkol03su@gmail.com',
                        password: 'password123'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Save data manually to test
                    const { tokens, user } = result.data;
                    const mappedUser = { ...user, role: user.userType || user.role };
                    
                    localStorage.setItem('hotel_auth_token', tokens.accessToken);
                    localStorage.setItem('hotel_auth_refresh_token', tokens.refreshToken);
                    localStorage.setItem('hotel_auth_user', JSON.stringify(mappedUser));
                    
                    document.getElementById('login-result').innerHTML = 
                        `<span class="success">‚úÖ Login successful!</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    
                    refreshLocalStorage();
                    checkUserRole();
                } else {
                    document.getElementById('login-result').innerHTML = 
                        `<span class="error">‚ùå Login failed:</span><pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                document.getElementById('login-result').innerHTML = 
                    `<span class="error">‚ùå Network error: ${error.message}</span>`;
            }
        }

        // Initialize
        refreshLocalStorage();
        checkUserRole();
    </script>
</body>
</html>
