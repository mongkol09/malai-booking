<!DOCTYPE html>
<html>
<head>
    <title>Token Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .token-display { word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        .payload { background: #e8f4fd; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Token Debug Tool</h1>
        
        <div class="section">
            <h3>Current Token Status</h3>
            <div id="tokenStatus"></div>
        </div>
        
        <div class="section">
            <h3>Token Details</h3>
            <div id="tokenDetails"></div>
        </div>
        
        <div class="section">
            <h3>Actions</h3>
            <button onclick="clearToken()">Clear Token</button>
            <button onclick="refresh()">Refresh</button>
            <button onclick="testLogin()">Test Login</button>
        </div>
        
        <div class="section">
            <h3>Login Test</h3>
            <div>
                <input type="email" id="email" placeholder="Email" value="admin@hotel.com">
                <input type="password" id="password" placeholder="Password" value="SecureAdmin123!">
                <button onclick="performLogin()">Login</button>
            </div>
            <div id="loginResult"></div>
        </div>
    </div>

    <script>
        const tokenKey = 'hotel_admin_token';
        const userKey = 'hotel_admin_user';
        const baseURL = 'http://localhost:3001/api/v1';

        function refresh() {
            checkTokenStatus();
        }

        function checkTokenStatus() {
            const token = localStorage.getItem(tokenKey);
            const user = localStorage.getItem(userKey);
            
            const statusEl = document.getElementById('tokenStatus');
            const detailsEl = document.getElementById('tokenDetails');
            
            if (!token) {
                statusEl.innerHTML = '<span class="error">‚ùå No token found</span>';
                detailsEl.innerHTML = 'No token to analyze';
                return;
            }
            
            // Display token
            detailsEl.innerHTML = `
                <h4>Raw Token:</h4>
                <div class="token-display">${token}</div>
                <h4>User Data:</h4>
                <div class="token-display">${user || 'No user data'}</div>
            `;
            
            // Validate token format
            const parts = token.split('.');
            if (parts.length !== 3) {
                statusEl.innerHTML = '<span class="error">‚ùå Invalid JWT format (must have 3 parts)</span>';
                return;
            }
            
            try {
                // Decode header
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                const currentTime = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp <= currentTime;
                const timeLeft = payload.exp - currentTime;
                
                statusEl.innerHTML = `
                    <span class="${isExpired ? 'error' : 'success'}">
                        ${isExpired ? '‚ùå Token Expired' : '‚úÖ Token Valid'}
                    </span>
                    <br>
                    Time left: ${timeLeft} seconds
                `;
                
                detailsEl.innerHTML += `
                    <h4>Header:</h4>
                    <div class="payload">${JSON.stringify(header, null, 2)}</div>
                    <h4>Payload:</h4>
                    <div class="payload">${JSON.stringify(payload, null, 2)}</div>
                `;
                
            } catch (error) {
                statusEl.innerHTML = '<span class="error">‚ùå Token decode failed: ' + error.message + '</span>';
            }
        }
        
        function clearToken() {
            localStorage.removeItem(tokenKey);
            localStorage.removeItem(userKey);
            localStorage.removeItem('hotel_admin_refresh_token');
            alert('Tokens cleared!');
            refresh();
        }
        
        async function performLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultEl = document.getElementById('loginResult');
            
            try {
                resultEl.innerHTML = 'üîÑ Logging in...';
                
                const response = await fetch(`${baseURL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store the token
                    localStorage.setItem(tokenKey, data.token);
                    localStorage.setItem(userKey, JSON.stringify(data.user));
                    
                    resultEl.innerHTML = '<span class="success">‚úÖ Login successful!</span>';
                    refresh();
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå Login failed: ' + data.message + '</span>';
                }
            } catch (error) {
                resultEl.innerHTML = '<span class="error">‚ùå Login error: ' + error.message + '</span>';
            }
        }
        
        // Initialize
        checkTokenStatus();
    </script>
</body>
</html>
