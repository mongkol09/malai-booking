<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Room Status Quick Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .results { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Room Status Quick Fix</h1>
        <p>‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Room Status ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏î‡πà‡∏ß‡∏ô</p>

        <div class="info">
            <h4>üéØ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h4>
            <ul>
                <li>‚ùå API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (11 ‡∏´‡πâ‡∏≠‡∏á) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Room Status</li>
                <li>‚ùå Missing formatRoomForStatus method ‡πÉ‡∏ô roomStatusService</li>
                <li>‚ùå ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ data structure ‡∏´‡∏£‡∏∑‡∏≠ frontend logic</li>
            </ul>
        </div>

        <div class="success">
            <h4>‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß:</h4>
            <ul>
                <li>‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° formatRoomForStatus method ‡πÉ‡∏ô roomStatusService</li>
                <li>‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° getStatusColor ‡πÅ‡∏•‡∏∞ getRoomStatusOptions methods</li>
                <li>‚úÖ Backend API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (11 ‡∏´‡πâ‡∏≠‡∏á)</li>
            </ul>
        </div>

        <div>
            <h4>üöÄ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</h4>
            <button onclick="testRoomStatusFlow()" class="btn-success">1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Room Status Flow</button>
            <button onclick="fixLocalStorage()" class="btn-warning">2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç LocalStorage</button>
            <button onclick="testFormatFunction()" class="btn-success">3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Format Function</button>
            <button onclick="debugCurrentIssue()" class="btn-danger">4. Debug ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        </div>

        <div id="results" class="results"></div>

        <div class="info">
            <h4>üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</h4>
            <ol>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Room Status Flow" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API</li>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç LocalStorage" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ token</li>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "4. Debug ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤</li>
                <li><strong>Refresh ‡∏´‡∏ô‡πâ‡∏≤ Room Status</strong> ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api/v1';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìã';
            results.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').textContent = '';
        }

        async function testRoomStatusFlow() {
            clearResults();
            log('üß™ Testing complete Room Status flow...');
            
            try {
                // Test API call
                const response = await fetch(`${API_BASE_URL}/rooms`, {
                    headers: { 'X-API-Key': 'dev-api-key-2024' }
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                log(`‚úÖ API Response received: ${data.success}`, 'success');
                log(`üìä Total rooms: ${data.data?.length || 0}`, 'info');
                
                if (data.data && data.data.length > 0) {
                    log('üè† Sample room data:', 'info');
                    const sampleRoom = data.data[0];
                    log(`   Room ID: ${sampleRoom.id}`, 'info');
                    log(`   Room Number: ${sampleRoom.number}`, 'info');
                    log(`   Room Type: ${sampleRoom.type}`, 'info');
                    log(`   Status: ${sampleRoom.status}`, 'info');
                    log(`   Price: ${sampleRoom.price}`, 'info');
                    
                    // Test format function simulation
                    log('üîß Testing format function...', 'info');
                    const formatted = formatRoomForStatus(sampleRoom);
                    log(`   Formatted Room Number: ${formatted.roomNumber}`, 'info');
                    log(`   Formatted Room Type: ${formatted.roomType}`, 'info');
                    log(`   Formatted Status: ${formatted.status}`, 'info');
                    log(`   Status Color: ${formatted.statusColor}`, 'info');
                    
                    log('üéâ Room Status API is working correctly!', 'success');
                    log('üí° If data still not showing, the issue is in frontend rendering logic', 'warning');
                } else {
                    log('‚ùå No room data received from API', 'error');
                }
                
            } catch (error) {
                log(`‚ùå API Test failed: ${error.message}`, 'error');
            }
        }

        async function fixLocalStorage() {
            clearResults();
            log('üîß Fixing localStorage configuration...');
            
            // Clear all old tokens
            const keysToRemove = ['token', 'hotel_admin_token', 'hotel_admin_refresh_token', 'hotel_admin_user'];
            keysToRemove.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Removed: ${key}`, 'info');
                }
            });
            
            // Set development token
            const devToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJkZXYtdXNlci0xMjMiLCJlbWFpbCI6ImFkbWluQGhvdGVsLmRldiIsInVzZXJUeXBlIjoiQURNSU4iLCJzZXNzaW9uSWQiOiJkZXYtc2Vzc2lvbi0xMjMiLCJpYXQiOjE3NTUyNTA1MjIsImV4cCI6MTc1NTMzNjkyMiwiYXVkIjoiaG90ZWwtYm9va2luZy1jbGllbnQiLCJpc3MiOiJob3RlbC1ib29raW5nLWFwaSJ9.CORKuf1uLhDEl2XwMmcQnZIgvlvV99K7Y_RLhJ_sbAc';
            
            localStorage.setItem('hotel_admin_token', devToken);
            
            // Set user data
            const userData = {
                id: 'dev-admin-123',
                email: 'admin@hotel.dev',
                userType: 'ADMIN',
                name: 'Development Admin'
            };
            localStorage.setItem('hotel_admin_user', JSON.stringify(userData));
            
            log('‚úÖ Development token set successfully!', 'success');
            log('‚úÖ User data configured', 'success');
            log('üéØ localStorage is now properly configured', 'success');
            
            // Test the configuration
            try {
                const response = await fetch(`${API_BASE_URL}/rooms`, {
                    headers: {
                        'Authorization': `Bearer ${devToken}`,
                        'X-API-Key': 'dev-api-key-2024'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Token authentication successful!', 'success');
                } else {
                    log('‚ö†Ô∏è Token auth failed, but dev bypass should work', 'warning');
                }
            } catch (error) {
                log(`‚ö†Ô∏è Token test error: ${error.message}`, 'warning');
            }
        }

        function testFormatFunction() {
            clearResults();
            log('üß™ Testing formatRoomForStatus function...');
            
            // Sample room data from API
            const sampleRoom = {
                id: "test-room-123",
                number: "ST001",
                type: "Standard Room",
                price: 3500,
                capacity: 2,
                status: "available"
            };
            
            log('üìã Sample room input:', 'info');
            log(JSON.stringify(sampleRoom, null, 2), 'info');
            
            const formatted = formatRoomForStatus(sampleRoom);
            
            log('üìã Formatted output:', 'info');
            log(JSON.stringify(formatted, null, 2), 'info');
            
            log('‚úÖ Format function test completed!', 'success');
        }

        async function debugCurrentIssue() {
            clearResults();
            log('üîç Debugging current Room Status issue...');
            
            // Check localStorage
            log('1. üîç Checking localStorage...', 'info');
            const token = localStorage.getItem('hotel_admin_token');
            const user = localStorage.getItem('hotel_admin_user');
            log(`   Token exists: ${!!token}`, token ? 'success' : 'error');
            log(`   User data exists: ${!!user}`, user ? 'success' : 'error');
            
            // Check API connectivity
            log('2. üîç Checking API connectivity...', 'info');
            try {
                const healthResponse = await fetch('http://localhost:3001/health');
                const healthData = await healthResponse.json();
                log(`   API Health: ${healthData.status}`, 'success');
                log(`   Database: ${healthData.database}`, 'success');
            } catch (error) {
                log(`   API Health Check failed: ${error.message}`, 'error');
                return;
            }
            
            // Check rooms API
            log('3. üîç Checking rooms API...', 'info');
            try {
                const roomsResponse = await fetch(`${API_BASE_URL}/rooms`, {
                    headers: { 'X-API-Key': 'dev-api-key-2024' }
                });
                
                if (roomsResponse.ok) {
                    const roomsData = await roomsResponse.json();
                    log(`   Rooms API: SUCCESS (${roomsData.data?.length || 0} rooms)`, 'success');
                } else {
                    log(`   Rooms API: FAILED (${roomsResponse.status})`, 'error');
                }
            } catch (error) {
                log(`   Rooms API error: ${error.message}`, 'error');
            }
            
            // Check frontend compatibility
            log('4. üîç Checking frontend compatibility...', 'info');
            if (typeof roomStatusService !== 'undefined') {
                log('   roomStatusService: Available in global scope', 'success');
            } else {
                log('   roomStatusService: NOT available in global scope', 'warning');
                log('   This is normal for React components', 'info');
            }
            
            // Final recommendations
            log('5. üìã Diagnosis complete!', 'info');
            log('üí° RECOMMENDATIONS:', 'warning');
            log('   1. API is working correctly ‚úÖ', 'info');
            log('   2. Data format functions added ‚úÖ', 'info');
            log('   3. Try: Refresh Room Status page now', 'warning');
            log('   4. If still not working: Check browser console for React errors', 'warning');
            log('   5. Make sure React dev server is running', 'warning');
        }

        // Helper function (same as in roomStatusService)
        function formatRoomForStatus(room) {
            return {
                id: room.id,
                roomNumber: room.number || room.roomNumber,
                roomType: room.type || 'Standard',
                floor: Math.floor(parseInt(room.number || room.roomNumber || '101') / 100) || 1,
                checkOut: room.checkOut || '-',
                status: room.status || 'available',
                statusColor: getStatusColor(room.status || 'available'),
                capacity: room.capacity || 2,
                price: room.price || 0
            };
        }
        
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'available': return 'bg-success';
                case 'occupied': return 'bg-danger';
                case 'dirty': return 'bg-warning';
                case 'maintenance': return 'bg-secondary';
                case 'out-of-order': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }

        // Auto-run basic check on load
        window.onload = function() {
            log('üöÄ Room Status Quick Fix Tool loaded');
            log('üìã Click buttons above to diagnose and fix issues');
        };
    </script>
</body>
</html>
